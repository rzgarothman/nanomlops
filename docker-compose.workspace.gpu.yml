services:
  workspace:
    build:
      context: ./build
      dockerfile: Dockerfile.workspace
      args:
        BASE_IMAGE: nvidia/cuda:12.6.3-devel-ubuntu24.04
        MLFLOW_VERSION: ${MLFLOW_PIP_VERSION:-3.5.1}
        PREFECT_VERSION: ${PREFECT_PIP_VERSION:-3.5.0}
        EVIDENTLY_VERSION: ${EVIDENTLY_PIP_VERSION:-0.7.18}
    container_name: ${WORKSPACE_NAME}
    restart: "no"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [ gpu ]
    environment:
      - PASSWORD=${WORKSPACE_PASSWORD}
      - JUPYTER_TOKEN=${WORKSPACE_TOKEN:-token}
      - MLFLOW_TRACKING_URI=http://mlops-mlflow:5000
      - PREFECT_API_URL=http://mlops-prefect:4200/api
      - MLFLOW_S3_ENDPOINT_URL=http://mlops-minio:9000
      - AWS_ACCESS_KEY_ID=${MINIO_ROOT_USER}
      - AWS_SECRET_ACCESS_KEY=${MINIO_ROOT_PASSWORD}
    volumes:
      - ${DATA_ROOT}/${WORKSPACE_NAME}/work:/home/jovyan/work
      - ${DATA_ROOT}/${WORKSPACE_NAME}/dvc_cache:/home/jovyan/.cache/dvc
      - ${DATA_ROOT}/${WORKSPACE_NAME}/vscode/config:/home/jovyan/.config/code-server
      - ${DATA_ROOT}/${WORKSPACE_NAME}/vscode/extensions:/home/jovyan/.local/share/code-server
      - ${DATA_ROOT}/${WORKSPACE_NAME}/jupyter/config:/home/jovyan/.jupyter
      - ${DATA_ROOT}/${WORKSPACE_NAME}/jupyter/local:/home/jovyan/.local/share/jupyter
    ports:
      - "${PORT_JUPYTER}:8888"
      - "${PORT_VSCODE}:8081"
      - "${PORT_BENTO}:3000"
      - "${PORT_STREAMLIT}:8501"
    networks:
      - mlops-net
    working_dir: /home/jovyan/work

  dashboard:
    image: nginx:alpine
    container_name: ${WORKSPACE_NAME}-dashboard
    restart: "no"
    environment:
      # 传入容器名称，供 nginx.conf.template 替换
      - WORKSPACE_NAME=${WORKSPACE_NAME}

      # 端口变量 (供 index.html.template 使用)
      - PORT_JUPYTER=${PORT_JUPYTER}
      - PORT_VSCODE=${PORT_VSCODE}
      - PORT_STREAMLIT=${PORT_STREAMLIT}
      # 基础设施端口 (通常从主 .env 读取，如果 .env.userX 未覆盖则使用默认值)
      - PORT_GITEA_HTTP=${PORT_GITEA_HTTP:-3000}
      - PORT_MLFLOW=${PORT_MLFLOW:-5000}
      - PORT_PREFECT=${PORT_PREFECT:-4200}
      - PORT_LABEL_STUDIO=${PORT_LABEL_STUDIO:-8080}
      - PORT_MINIO_CONSOLE=${PORT_MINIO_CONSOLE:-9001}
      - PORT_GRAFANA=${PORT_GRAFANA:-3001}
      - PORT_EVIDENTLY=${PORT_EVIDENTLY:-8000}
    volumes:
      - ./config/nginx/nginx.conf.template:/etc/nginx/conf.d/default.conf
      - ./config/nginx/index.html.template:/etc/nginx/html_templates/index.html.template
    ports:
      # 导航页端口
      - "${PORT_NAV:-80}:80"
    networks:
      - mlops-net
    # 使用 \$$ 转义变量：
    # 1. Compose 将 \$$ 解析为 \$
    # 2. 容器内 shell 将 \$ 转义为 $ (字面量)
    # 3. envsubst 接收到字符串 '$PORT_...'，从而正确替换模板中的变量
    command: >
      /bin/sh -c "envsubst '\$$PORT_JUPYTER \$$PORT_VSCODE \$$PORT_STREAMLIT \$$PORT_GITEA_HTTP \$$PORT_MLFLOW \$$PORT_PREFECT \$$PORT_LABEL_STUDIO \$$PORT_MINIO_CONSOLE \$$PORT_GRAFANA \$$PORT_EVIDENTLY' < /etc/nginx/html_templates/index.html.template > /usr/share/nginx/html/index.html && exec nginx -g 'daemon off;'"

networks:
  mlops-net:
    name: mlops-shared-net
    external: true
